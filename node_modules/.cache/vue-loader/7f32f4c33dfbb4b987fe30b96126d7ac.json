{"remainingRequest":"/home/tiendzung/workspace/video5pm/video5pm-ui/node_modules/vue-loader/lib/index.js??vue-loader-options!/home/tiendzung/workspace/video5pm/video5pm-ui/src/packages/order-mapping/views/OptionMappingForm.vue?vue&type=script&lang=js&","dependencies":[{"path":"/home/tiendzung/workspace/video5pm/video5pm-ui/src/packages/order-mapping/views/OptionMappingForm.vue","mtime":1604479001989},{"path":"/home/tiendzung/workspace/video5pm/video5pm-ui/node_modules/babel-loader/lib/index.js","mtime":1604479000077},{"path":"/home/tiendzung/workspace/video5pm/video5pm-ui/node_modules/cache-loader/dist/cjs.js","mtime":1604479000133},{"path":"/home/tiendzung/workspace/video5pm/video5pm-ui/node_modules/vue-loader/lib/index.js","mtime":1604479001773}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport { mapActions, mapState } from 'vuex'\nimport { cloneDeep, isObjectDiff } from '@core/utils'\nimport { types } from '../constant'\nexport default {\n  name: 'OptionMappingForm',\n  data() {\n    return {\n      mode: 'new',\n      form: {\n        product_type_id: null,\n        /**\n         * [{\n            option_set: {\n              condition: '',\n              target_value: null,\n            },\n            option: {\n              conditions: '',\n              values: [],\n              target_values: [],\n            },\n          }],\n         */\n        rules: [],\n      },\n      initialForm: {},\n      isShowUnsavedBar: false,\n      isFetching: false,\n      isSaving: false,\n      isDeleting: false,\n    }\n  },\n  computed: {\n    ...mapState('orderMapping', {\n      optionMappingState: (state) => state.orderMapping,\n      products: (state) => state.productTypes,\n      options: (state) => state.options,\n      optionSets: (state) => state.optionSets,\n    }),\n    pageTitle() {\n      return this.mode === 'new'\n        ? 'Create option mapping rule'\n        : 'Update option mapping rule'\n    },\n    getOptionsWithOptionSetId() {\n      return (id) => {\n        return this.options.filter((option) => option.option_set_id === id)\n      }\n    },\n    getOptionValueByIndex() {\n      return (ruleIndex, index) => {\n        const rule = this.form.rules[ruleIndex]\n        if (!rule) {\n          return null\n        }\n        const value = rule.option.values[index]\n        if (!value) {\n          return null\n        }\n        return value\n      }\n    },\n    getOptionTargetValueByIndex() {\n      return (ruleIndex, index) => {\n        const rule = this.form.rules[ruleIndex]\n        if (!rule) {\n          return null\n        }\n        const targetValue = rule.option.target_values[index]\n        if (!targetValue) {\n          return null\n        }\n        return targetValue\n      }\n    },\n  },\n  watch: {\n    form: {\n      handler(val) {\n        this.isShowUnsavedBar = isObjectDiff(val, this.initialForm)\n      },\n      deep: true,\n    },\n    initialForm: {\n      handler(val) {\n        this.isShowUnsavedBar = isObjectDiff(val, this.form)\n      },\n      deep: true,\n    },\n  },\n  methods: {\n    ...mapActions('orderMapping', {\n      createOrUpdateOrderMapping: 'createOrUpdateOrderMapping',\n      fetchOrderMapping: 'fetchOrderMapping',\n      deleteOrderMapping: 'deleteOrderMapping',\n      fetchProductTypes: 'fetchProductTypes',\n      fetchOptionsByProductId: 'fetchOptionsByProductId',\n    }),\n    addNewOption() {\n      const rules = this.form.rules\n      rules.push({\n        option_set: {\n          condition: '',\n          target_value: null,\n        },\n        option: {\n          conditions: '',\n          values: [],\n          target_values: [],\n        },\n      })\n    },\n    deleteOption(index) {\n      this.form.rules.splice(index, 1)\n    },\n    onOptionSetTargetValueChange(rule, val) {\n      rule.option_set.target_value = val\n      const options = this.getOptionsWithOptionSetId(val)\n      rule.option.target_values = options.map((option) => option.id)\n    },\n    onRuleOptionConditionsChange(rule, val) {\n      rule.option.conditions = val\n\n      const newConditionsArr = val\n        .split(',')\n        .filter((condition) => condition.trim() !== '')\n\n      rule.option.values.forEach((value, index) => {\n        if (newConditionsArr[index]) {\n          rule.option.values[index] = newConditionsArr[index]\n        }\n      })\n      if (newConditionsArr.length > rule.option.values.length) {\n        newConditionsArr\n          .slice(rule.option.values.length)\n          .forEach((condition) => {\n            rule.option.values.push(condition)\n          })\n      } else if (newConditionsArr.length < rule.option.values.length) {\n        rule.option.values = rule.option.values.slice(\n          0,\n          newConditionsArr.length\n        )\n      }\n    },\n    setOptionValueByIndex(ruleIndex, index, value) {\n      const rule = this.form.rules[ruleIndex]\n      this.$set(rule.option.values, index, value)\n    },\n    setOptionTargetValueByIndex(ruleIndex, index, value) {\n      const rule = this.form.rules[ruleIndex]\n      this.$set(rule.option.target_values, index, value)\n    },\n    async onProductTypeChange(id) {\n      const result = await this.fetchOptionsByProductId(id)\n      if (!result.success) {\n        this.$toast.open({\n          type: 'error',\n          message:\n            result.message || 'Something went wrong. Please try again later',\n        })\n      }\n    },\n    async fetch() {\n      this.isFetching = true\n      const promises = [this.fetchProductTypes()]\n      if (this.$route.params.id && this.$route.params.id !== 'new') {\n        this.mode = 'edit'\n        promises.push(\n          this.fetchOrderMapping({\n            type: types.option,\n            id: +this.$route.params.id,\n          })\n        )\n      }\n      const [, res2] = await Promise.all(promises)\n      if (res2 && res2.success) {\n        await this.transformStateToLocalForm(this.optionMappingState)\n      }\n      this.initialForm = cloneDeep(this.form)\n      this.isFetching = false\n    },\n    async transformStateToLocalForm(data) {\n      this.form.product_type_id = data.product_type_id\n      const result = await this.fetchOptionsByProductId(data.product_type_id)\n      if (!result.success) {\n        this.$toast.open({\n          type: 'error',\n          message:\n            result.message || 'Something went wrong. Please try again later',\n        })\n        return\n      }\n\n      // find all option_set rules\n      const optionSetRules = data.rules.filter(\n        (rule) => rule.column === 'option_set'\n      )\n      this.form.rules = optionSetRules.map((optionSetRule) => {\n        const formRule = {\n          option_set: {\n            condition: optionSetRule.condition,\n            target_value: optionSetRule.target_value\n              ? parseInt(optionSetRule.target_value)\n              : null,\n          },\n          option: {\n            conditions: '',\n            values: [],\n            target_values: [],\n          },\n        }\n\n        if (optionSetRule.target_value) {\n          //now find all option rules attach to this option set rules\n          const optionIds = this.getOptionsWithOptionSetId(\n            parseInt(optionSetRule.target_value)\n          ).map((option) => option.id)\n\n          const optionRules = data.rules.filter(\n            (rule) =>\n              rule.column === 'option' &&\n              rule.target_value &&\n              optionIds.indexOf(parseInt(rule.target_value)) > -1\n          )\n\n          formRule.option.values = optionRules.map(\n            (optionRule) => optionRule.condition\n          )\n          formRule.option.target_values = optionRules.map((optionRule) =>\n            optionRule.target_value ? parseInt(optionRule.target_value) : null\n          )\n          formRule.option.conditions = formRule.option.values.join(',')\n        }\n\n        return formRule\n      })\n    },\n    tranformLocalFormToPayload() {\n      const payload = {\n        product_type_id: this.form.product_type_id,\n        rules: [],\n        type: types.option,\n        disjunctive: false,\n      }\n      if (this.mode !== 'new') {\n        payload.id = this.optionMappingState.id\n      }\n      this.form.rules.map((rule) => {\n        // option set\n        payload.rules.push({\n          column: 'option_set',\n          relation: 'equal',\n          condition: rule.option_set.condition,\n          target_value: String(rule.option_set.target_value),\n        })\n        // option\n        rule.option.values.map((value, index) => {\n          payload.rules.push({\n            column: 'option',\n            relation: 'equal',\n            condition: value,\n            target_value: String(rule.option.target_values[index]),\n          })\n        })\n      })\n\n      return payload\n    },\n    discard() {\n      this.form = cloneDeep(this.initialForm)\n    },\n    showConfirmDelete() {\n      this.$dialog.confirm({\n        title: `Delete option mapping?`,\n        message: `Are you sure you want to delete this option mapping?`,\n        confirmText: 'Delete',\n        onConfirm: () => this.delete(),\n        type: 'danger',\n      })\n    },\n    async save() {\n      const isValid = await this.$validator.validateAll()\n      if (!isValid) return\n      this.isSaving = true\n      if (this.mode === 'new') {\n        await this.create()\n      } else {\n        await this.update()\n      }\n      this.isSaving = false\n    },\n    async create() {\n      const payload = this.tranformLocalFormToPayload()\n      const response = await this.createOrUpdateOrderMapping({\n        type: types.option,\n        payload,\n      })\n      if (response.success) {\n        this.$toast.open({\n          type: 'success',\n          message: 'Your option mapping was created',\n        })\n        this.$router.push({\n          name: 'option-mapping-update',\n          params: {\n            id: response.id,\n          },\n        })\n      } else {\n        this.$toast.open({\n          type: 'error',\n          message:\n            response.message || 'Something went wrong. Please try again later',\n        })\n      }\n    },\n    async update() {\n      const payload = this.tranformLocalFormToPayload()\n      const response = await this.createOrUpdateOrderMapping({\n        type: types.option,\n        payload,\n      })\n      if (response.success) {\n        this.$toast.open({\n          type: 'success',\n          message: 'Your option mapping was updated',\n        })\n        await this.fetch()\n      } else {\n        this.$toast.open({\n          type: 'error',\n          message:\n            response.message || 'Something went wrong. Please try again later',\n        })\n      }\n    },\n    async delete() {\n      this.isDeleting = true\n      const response = await this.deleteOrderMapping({\n        type: types.option,\n        id: this.optionMappingState.id,\n      })\n      if (response.success) {\n        this.$toast.open({\n          type: 'success',\n          message: 'Your option mapping was deleted',\n        })\n        this.$router.push({\n          name: 'option-mapping-list',\n        })\n      } else {\n        this.$toast.open({\n          type: 'error',\n          message:\n            response.message || 'Something went wrong. Please try again later',\n        })\n      }\n      this.isDeleting = false\n    },\n  },\n  created() {\n    this.fetch()\n  },\n}\n",null]}